# CLAW.AI ç¼“å­˜å®ç°æ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†ä¸º CLAW.AI é¡¹ç›®å®ç°çš„å®Œæ•´ç¼“å­˜ç­–ç•¥ç³»ç»Ÿã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒç¼“å­˜æœåŠ¡

**æ–‡ä»¶ï¼š** `/home/wuying/clawd/claw-ai-backend/app/services/cache_service.py`

**åŠŸèƒ½ï¼š**
- âœ… Redis ç¼“å­˜åç«¯é›†æˆ
- âœ… å¤šçº§ç¼“å­˜ï¼ˆå†…å­˜ + Redisï¼‰
- âœ… TTL è‡ªåŠ¨è¿‡æœŸç®¡ç†
- âœ… ç¼“å­˜é”®ç”Ÿæˆå’Œç®¡ç†
- âœ… ç¼“å­˜æ ‡ç­¾æ”¯æŒ
- âœ… æ‰¹é‡å¤±æ•ˆåŠŸèƒ½
- âœ… ç¼“å­˜ç»Ÿè®¡ç›‘æ§
- âœ… 6 ä¸ªé¢„å®šä¹‰ç¼“å­˜åœºæ™¯ï¼š
  - `user_profile` (1h)
  - `user_conversations` (10m)
  - `conversation_history` (30m)
  - `document_content` (1h)
  - `ai_response` (24h)
  - `rate_limit` (1m)

---

### 2. ç¼“å­˜è£…é¥°å™¨

**æ–‡ä»¶ï¼š** `/home/wuying/clawd/claw-ai-backend/app/core/cache.py`

**åŠŸèƒ½ï¼š**
- âœ… `@cached` - åŸºç¡€ç¼“å­˜è£…é¥°å™¨
- âœ… `@cache_by_tags` - åŸºäºæ ‡ç­¾çš„ç¼“å­˜
- âœ… `@rate_limit` - API é™æµè£…é¥°å™¨
- âœ… è‡ªå®šä¹‰ç¼“å­˜é”®ç”Ÿæˆå™¨
- âœ… ç¼“å­˜é¢„çƒ­å™¨ï¼ˆCacheWarmerï¼‰
- âœ… è‡ªåŠ¨åŒæ­¥/å¼‚æ­¥å‡½æ•°æ”¯æŒ

---

### 3. ç¼“å­˜ç®¡ç† API

**æ–‡ä»¶ï¼š** `/home/wuying/clawd/claw-ai-backend/app/api/cache.py`

**API ç«¯ç‚¹ï¼š**
- âœ… `GET /api/v1/cache/stats` - è·å–ç¼“å­˜ç»Ÿè®¡
- âœ… `GET /api/v1/cache/scenarios` - è·å–ç¼“å­˜åœºæ™¯é…ç½®
- âœ… `GET /api/v1/cache/keys` - è·å–ç¼“å­˜é”®åˆ—è¡¨
- âœ… `GET /api/v1/cache/keys/{key}` - è·å–ç‰¹å®šç¼“å­˜å€¼
- âœ… `DELETE /api/v1/cache/stats/reset` - é‡ç½®ç»Ÿè®¡
- âœ… `DELETE /api/v1/cache/keys/{key}` - åˆ é™¤ç‰¹å®šé”®
- âœ… `POST /api/v1/cache/invalidate/by-tags` - æ ‡ç­¾æ‰¹é‡å¤±æ•ˆ
- âœ… `POST /api/v1/cache/invalidate/by-scenario` - åœºæ™¯æ‰¹é‡å¤±æ•ˆ
- âœ… `DELETE /api/v1/cache/all` - æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
- âœ… `POST /api/v1/cache/warmup` - è§¦å‘ç¼“å­˜é¢„çƒ­
- âœ… `GET /api/v1/cache/health` - ç¼“å­˜å¥åº·æ£€æŸ¥

---

### 4. ç¼“å­˜å¢å¼ºçš„å¯¹è¯æœåŠ¡

**æ–‡ä»¶ï¼š** `/home/wuying/clawd/claw-ai-backend/app/services/cached_conversation_service.py`

**åŠŸèƒ½ï¼š**
- âœ… å¯¹è¯åˆ—è¡¨ç¼“å­˜ï¼ˆ10 åˆ†é’Ÿ TTLï¼‰
- âœ… å¯¹è¯è¯¦æƒ…ç¼“å­˜ï¼ˆ30 åˆ†é’Ÿ TTLï¼‰
- âœ… æ¶ˆæ¯åˆ—è¡¨ç¼“å­˜ï¼ˆ30 åˆ†é’Ÿ TTLï¼‰
- âœ… AI å“åº”ç¼“å­˜ï¼ˆ24 å°æ—¶ TTLï¼‰
- âœ… æ•°æ®æ›´æ–°æ—¶è‡ªåŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜

---

### 5. ç¼“å­˜é¢„çƒ­ç³»ç»Ÿ

**æ–‡ä»¶ï¼š** `/home/wuying/clawd/claw-ai-backend/app/services/cache_warmup.py`

**é¢„çƒ­ä»»åŠ¡ï¼š**
- âœ… æ´»è·ƒç”¨æˆ·ä¿¡æ¯é¢„çƒ­ï¼ˆæ¯å°æ—¶ï¼‰
- âœ… çƒ­é—¨å¯¹è¯å†å²é¢„çƒ­ï¼ˆæ¯ 30 åˆ†é’Ÿï¼‰
- âœ… å¸¸ç”¨çŸ¥è¯†åº“æ–‡æ¡£é¢„çƒ­ï¼ˆæ¯å°æ—¶ï¼‰
- âœ… æ”¯æŒå‘¨æœŸæ€§é¢„çƒ­ï¼ˆåå°ä»»åŠ¡ï¼‰

---

### 6. æ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| ç¼“å­˜ç­–ç•¥æ–‡æ¡£ | `/docs/CACHE_STRATEGY.md` | å®Œæ•´çš„ç¼“å­˜ç­–ç•¥å’ŒæŠ€æœ¯æ–‡æ¡£ |
| å¿«é€Ÿå¼€å§‹æŒ‡å— | `/docs/CACHE_QUICKSTART.md` | ç¼“å­˜ç³»ç»Ÿå¿«é€Ÿä½¿ç”¨æŒ‡å— |
| ä½¿ç”¨ç¤ºä¾‹ | `/app/examples/cache_examples.py` | å„ç§ç¼“å­˜ä½¿ç”¨åœºæ™¯çš„ä»£ç ç¤ºä¾‹ |
| æµ‹è¯•è„šæœ¬ | `/tests/test_cache.py` | ç¼“å­˜åŠŸèƒ½æµ‹è¯•è„šæœ¬ |

---

### 7. ä¸»åº”ç”¨é›†æˆ

**æ›´æ–°æ–‡ä»¶ï¼š** `/home/wuying/clawd/claw-ai-backend/app/main.py`

**é›†æˆå†…å®¹ï¼š**
- âœ… å¯¼å…¥ç¼“å­˜æ¨¡å—
- âœ… æ³¨å†Œç¼“å­˜ç®¡ç† API è·¯ç”±
- âœ… åº”ç”¨å¯åŠ¨æ—¶è¿æ¥ç¼“å­˜æœåŠ¡
- âœ… åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œç¼“å­˜é¢„çƒ­
- âœ… åº”ç”¨å…³é—­æ—¶æ–­å¼€ç¼“å­˜è¿æ¥

---

## ğŸ“Š æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI åº”ç”¨å±‚                         â”‚
â”‚  (API è·¯ç”±ã€ä¸šåŠ¡é€»è¾‘ã€æœåŠ¡å±‚)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    ç¼“å­˜è£…é¥°å™¨           â”‚
         â”‚  (@cached, @rate_limit) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ç¼“å­˜æœåŠ¡å±‚            â”‚
         â”‚  (CacheService)        â”‚
         â”‚  - é”®ç”Ÿæˆ               â”‚
         â”‚  - TTL ç®¡ç†             â”‚
         â”‚  - ç»Ÿè®¡ç›‘æ§             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸€çº§ç¼“å­˜       â”‚      â”‚  äºŒçº§ç¼“å­˜        â”‚
â”‚  (å†…å­˜ç¼“å­˜)     â”‚      â”‚  (Redis)        â”‚
â”‚  - å­—å…¸å­˜å‚¨     â”‚      â”‚  - åˆ†å¸ƒå¼        â”‚
â”‚  - å¿«é€Ÿè®¿é—®     â”‚      â”‚  - æŒä¹…åŒ–        â”‚
â”‚  - è‡ªåŠ¨è¿‡æœŸ     â”‚      â”‚  - è‡ªåŠ¨è¿‡æœŸ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ç¼“å­˜åœºæ™¯é…ç½®

| åœºæ™¯ | TTL | å‰ç¼€ | ç”¨é€” |
|------|-----|------|------|
| user_profile | 3600s (1h) | `user:profile` | ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ |
| user_conversations | 600s (10m) | `user:conversations` | å¯¹è¯åˆ—è¡¨ç¼“å­˜ |
| conversation_history | 1800s (30m) | `conversation:history` | å¯¹è¯å†å²ç¼“å­˜ |
| document_content | 3600s (1h) | `doc:content` | çŸ¥è¯†åº“æ–‡æ¡£ç¼“å­˜ |
| ai_response | 86400s (24h) | `ai:response` | AI å“åº”ç¼“å­˜ |
| rate_limit | 60s (1m) | `rate:limit` | API é™æµç¼“å­˜ |

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### ç¼“å­˜ç»Ÿè®¡ API
```bash
GET /api/v1/cache/stats
```

### æŒ‡æ ‡è¯´æ˜
- **hits**: ç¼“å­˜å‘½ä¸­æ¬¡æ•°
- **misses**: ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°
- **sets**: ç¼“å­˜è®¾ç½®æ¬¡æ•°
- **deletes**: ç¼“å­˜åˆ é™¤æ¬¡æ•°
- **errors**: ç¼“å­˜æ“ä½œé”™è¯¯æ¬¡æ•°
- **hit_rate**: ç¼“å­˜å‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
- **memory_cache_size**: å†…å­˜ç¼“å­˜ä¸­çš„é”®æ•°é‡
- **redis_connected**: Redis è¿æ¥çŠ¶æ€

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### 1. åœ¨æœåŠ¡ä¸­ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨

```python
from app.core.cache import cached

@cached(scenario="user_profile", ttl=3600)
async def get_user(user_id: int):
    return await db.query(User).filter(User.id == user_id).first()
```

### 2. ä½¿ç”¨ç¼“å­˜æ ‡ç­¾

```python
from app.core.cache import cache_by_tags

@cache_by_tags(tags=["user:123"])
async def get_user_data(user_id: int):
    return await db.query(User).filter(User.id == user_id).first()
```

### 3. API é™æµ

```python
from app.core.cache import rate_limit

@router.get("/api/endpoint")
@rate_limit(max_requests=100, window=60)
async def my_endpoint():
    return {"message": "Hello"}
```

### 4. æ‰‹åŠ¨ä½¿ç”¨ç¼“å­˜æœåŠ¡

```python
from app.services.cache_service import cache_service

# è®¾ç½®ç¼“å­˜
await cache_service.set(key, value, ttl=3600, tags=["tag1"])

# è·å–ç¼“å­˜
value = await cache_service.get(key)

# æ‰¹é‡å¤±æ•ˆ
await cache_service.delete_by_tags(["tag1"])
```

---

## ğŸš€ å¯åŠ¨æµç¨‹

1. **åº”ç”¨å¯åŠ¨**
   ```bash
   python -m uvicorn app.main:app --reload
   ```

2. **è‡ªåŠ¨æ‰§è¡Œ**
   - âœ… è¿æ¥ Redis ç¼“å­˜æœåŠ¡
   - âœ… æ‰§è¡Œç¼“å­˜é¢„çƒ­ï¼ˆæ´»è·ƒç”¨æˆ·ã€çƒ­é—¨å¯¹è¯ã€å¸¸ç”¨æ–‡æ¡£ï¼‰
   - âœ… æ³¨å†Œç¼“å­˜ç®¡ç† API

3. **éªŒè¯ç¼“å­˜çŠ¶æ€**
   ```bash
   curl http://localhost:8000/api/v1/cache/health
   ```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œç¼“å­˜æµ‹è¯•

```bash
cd /home/wuying/clawd/claw-ai-backend
python tests/test_cache.py
```

### æµ‹è¯•è¦†ç›–
- âœ… ç¼“å­˜æœåŠ¡åŸºæœ¬åŠŸèƒ½
- âœ… ç¼“å­˜è£…é¥°å™¨
- âœ… æ‰€æœ‰ç¼“å­˜åœºæ™¯
- âœ… ç¼“å­˜æ ‡ç­¾
- âœ… ç¼“å­˜é¢„çƒ­

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

1. **[ç¼“å­˜ç­–ç•¥æ–‡æ¡£](docs/CACHE_STRATEGY.md)** - å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£
   - ç¼“å­˜æ¶æ„è®¾è®¡
   - ç¼“å­˜åœºæ™¯é…ç½®
   - æŠ€æœ¯å®ç°ç»†èŠ‚
   - æ€§èƒ½ä¼˜åŒ–å»ºè®®
   - æ•…éšœå¤„ç†æŒ‡å—

2. **[å¿«é€Ÿå¼€å§‹æŒ‡å—](docs/CACHE_QUICKSTART.md)** - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
   - å¿«é€Ÿå¼€å§‹æ­¥éª¤
   - å¸¸ç”¨ API ç¤ºä¾‹
   - å¸¸è§é—®é¢˜è§£ç­”

3. **[ä½¿ç”¨ç¤ºä¾‹](app/examples/cache_examples.py)** - ä»£ç ç¤ºä¾‹
   - åŸºç¡€ç¼“å­˜ä½¿ç”¨
   - é«˜çº§ç‰¹æ€§æ¼”ç¤º
   - å®é™…åœºæ™¯åº”ç”¨

---

## ğŸ‰ å®Œæˆæ¸…å•

### æ ¸å¿ƒåŠŸèƒ½ âœ…
- [x] è®¾è®¡ç¼“å­˜æ¶æ„å’Œç­–ç•¥
- [x] åˆ›å»º Redis ç¼“å­˜æœåŠ¡å±‚
- [x] å®ç°ç¼“å­˜è£…é¥°å™¨ï¼ˆè£…é¥°å™¨æ¨¡å¼ï¼‰
- [x] å®ç°ç¼“å­˜å¤±æ•ˆæœºåˆ¶
- [x] å®ç°ç¼“å­˜é¢„çƒ­ç­–ç•¥
- [x] æ·»åŠ ç¼“å­˜ç›‘æ§æ¥å£

### æ–‡ä»¶åˆ›å»º âœ…
- [x] `app/services/cache_service.py`
- [x] `app/core/cache.py`
- [x] `app/api/cache.py`
- [x] `app/services/cached_conversation_service.py`
- [x] `app/services/cache_warmup.py`
- [x] `docs/CACHE_STRATEGY.md`
- [x] `docs/CACHE_QUICKSTART.md`
- [x] `app/examples/cache_examples.py`
- [x] `tests/test_cache.py`

### é›†æˆå·¥ä½œ âœ…
- [x] æ›´æ–°ç°æœ‰æœåŠ¡æ·»åŠ ç¼“å­˜
- [x] æ³¨å†Œç¼“å­˜ç®¡ç† API åˆ°ä¸»åº”ç”¨
- [x] åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–ç¼“å­˜æœåŠ¡
- [x] åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œç¼“å­˜é¢„çƒ­

### æ–‡æ¡£ âœ…
- [x] ç¼“å­˜ç­–ç•¥æ–‡æ¡£
- [x] å¿«é€Ÿå¼€å§‹æŒ‡å—
- [x] ä½¿ç”¨ç¤ºä¾‹ä»£ç 
- [x] æµ‹è¯•è„šæœ¬

---

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**
   - é…ç½® Redis æŒä¹…åŒ–ï¼ˆRDB/AOFï¼‰
   - è®¾ç½® Redis å¯†ç å’Œ TLS
   - é…ç½® Redis ä¸»ä»å¤åˆ¶
   - ç›‘æ§ Redis æ€§èƒ½æŒ‡æ ‡

2. **é«˜çº§ç‰¹æ€§**
   - å®ç°ç¼“å­˜ç©¿é€ä¿æŠ¤ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰
   - å®ç°ç¼“å­˜é›ªå´©ä¿æŠ¤ï¼ˆéšæœº TTLï¼‰
   - å®ç°ç¼“å­˜å‡»ç©¿ä¿æŠ¤ï¼ˆäº’æ–¥é”ï¼‰
   - æ·»åŠ ç¼“å­˜å‹ç¼©ï¼ˆå¤§å¯¹è±¡ï¼‰

3. **ç›‘æ§é›†æˆ**
   - é›†æˆ Prometheus æŒ‡æ ‡
   - è®¾ç½®ç¼“å­˜å‘½ä¸­ç‡å‘Šè­¦
   - ç›‘æ§ Redis å†…å­˜ä½¿ç”¨
   - ç›‘æ§ç¼“å­˜å“åº”æ—¶é—´

4. **æ‰©å±•åœºæ™¯**
   - æ·»åŠ  CDN ç¼“å­˜å±‚
   - æ·»åŠ æœ¬åœ°ç¼“å­˜ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰
   - å®ç°åˆ†å¸ƒå¼é”
   - å®ç°ç¼“å­˜é™çº§ç­–ç•¥

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- ğŸ“– [ç¼“å­˜ç­–ç•¥æ–‡æ¡£](docs/CACHE_STRATEGY.md)
- ğŸš€ [å¿«é€Ÿå¼€å§‹æŒ‡å—](docs/CACHE_QUICKSTART.md)
- ğŸ’» [ä½¿ç”¨ç¤ºä¾‹](app/examples/cache_examples.py)
- ğŸ§ª [æµ‹è¯•è„šæœ¬](tests/test_cache.py)

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0.0
**å®Œæˆæ—¥æœŸï¼š** 2024-02-14
**å®ç°è€…ï¼š** Cache Expert Agent
