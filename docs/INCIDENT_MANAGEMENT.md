# CLAW.AI 问题诊断与事故管理流程

**文档版本:** v1.0
**创建日期:** 2026-02-14
**适用范围:** 全体技术团队

---

## 1. 概述

### 1.1 目标

- **快速响应**: 最小化故障对用户的影响
- **透明沟通**: 及时向相关方通报事故进展
- **持续改进**: 通过事故复盘提升系统稳定性
- **知识沉淀**: 建立问题诊断知识库

### 1.2 事故定义

**事故 (Incident):** 任何影响用户正常使用系统的事件，包括但不限于：
- 系统不可用或部分功能异常
- 性能严重下降
- 数据丢失或损坏
- 安全漏洞或数据泄露

**事故级别:**

| 级别 | 名称 | 影响 | 响应时间 |
|------|------|------|---------|
| P0 | 严重 | 系统完全不可用，所有用户受影响 | 30 分钟 |
| P1 | 高 | 核心功能不可用，大部分用户受影响 | 1 小时 |
| P2 | 中 | 部分功能异常，部分用户受影响 | 4 小时 |
| P3 | 低 | 轻微问题，少量用户受影响 | 24 小时 |

---

## 2. 事故响应流程

### 2.1 事故发现与报告

#### 2.1.1 发现途径

1. **监控系统**
   - 自动告警触发
   - 指标异常检测

2. **用户反馈**
   - 客服工单
   - 用户投诉
   - 社交媒体反馈

3. **内部发现**
   - 测试发现问题
   - 运维巡检发现
   - 代码审查发现问题

#### 2.1.2 报告渠道

| 途径 | 适用场景 | 联系方式 |
|------|---------|---------|
| 飞书群 | 紧急事故 (P0/P1) | @技术团队 |
| 邮件 | 非紧急事故 (P2/P3) | tech-support@claw.ai |
| 工单系统 | 用户反馈事故 | 内部工单系统 |
| 监控系统 | 自动告警事故 | 自动创建 |

#### 2.1.3 事故报告模板

**飞书/邮件模板:**

```
【事故报告】P{级别} - {事故简述}

事故级别: P0/P1/P2/P3
影响范围: {受影响的功能/用户}
事故时间: {开始时间}
报告人: {姓名}
联系方式: {手机号}

事故描述:
{详细描述事故现象}

影响评估:
{评估事故对用户和业务的影响}

已采取的措施:
{已采取的临时措施}

需要支持:
{需要的支持，如人力、资源等}
```

---

### 2.2 事故响应

#### 2.2.1 响应团队

| 角色 | 职责 | 联系方式 |
|------|------|---------|
| 事故指挥官 (IC) | 统筹事故处理，决策资源调配 | IC-oncall@claw.ai |
| 技术负责人 | 技术方案决策，协调技术团队 | tech-lead@claw.ai |
| 传播负责人 | 对外沟通，发布事故公告 | comms@claw.ai |
| 后端工程师 | 问题定位，故障修复 | backend-team@claw.ai |
| 运维工程师 | 基础设施支持，系统恢复 | ops-team@claw.ai |
| DBA | 数据库问题处理 | dba@claw.ai |

#### 2.2.2 响应时间线

| 时间节点 | 动作 | 负责人 |
|---------|------|-------|
| 0 分钟 | 收到事故报告 | 任意人员 |
| 5 分钟 | 确认事故级别，任命 IC | IC |
| 10 分钟 | 组建响应团队，建立沟通渠道 | IC |
| 15 分钟 | 完成初步影响评估 | IC |
| 30 分钟 | 制定修复方案，开始修复 | 技术负责人 |
| 1 小时 | P0/P1 事故进展通报 | 传播负责人 |

#### 2.2.3 事故状态定义

| 状态 | 说明 |
|------|------|
| 检测中 | 事故刚被发现，正在评估 |
| 调查中 | 正在定位问题根因 |
| 修复中 | 已找到根因，正在修复 |
| 监控中 | 修复完成，正在观察 |
| 已解决 | 事故已完全解决 |
| 已关闭 | 事故复盘完成，文档已归档 |

---

### 2.3 事故处理

#### 2.3.1 问题诊断步骤

##### 步骤 1: 信息收集 (5-10 分钟)

**收集信息清单:**

1. **事故现象**
   - 事故开始时间
   - 受影响的功能/模块
   - 受影响的用户数量和范围
   - 错误信息截图/日志

2. **监控数据**
   - 相关指标变化趋势
   - 错误日志统计
   - 系统资源使用情况
   - 依赖服务状态

3. **变更记录**
   - 最近部署的代码版本
   - 配置变更记录
   - 基础设施变更记录

4. **用户反馈**
   - 用户报告的具体问题
   - 出现问题的用户特征
   - 问题复现步骤

**工具:**
- Grafana - 查看监控指标
- Kibana - 查看应用日志
- Prometheus - 查询指标数据
- Git - 查看代码变更历史

---

##### 步骤 2: 问题定位 (10-30 分钟)

**定位方法:**

1. **分层排查**

```
用户层 → 应用层 → 中间件层 → 基础设施层
```

2. **常见问题排查表**

| 症状 | 可能原因 | 排查方法 |
|------|---------|---------|
| 系统完全不可用 | 服务器宕机、网络中断、域名解析失败 | ping 服务器、检查网络、DNS 查询 |
| API 响应慢 | 数据库慢查询、第三方接口超时、代码逻辑问题 | 慢查询日志、接口响应时间、代码审查 |
| 数据库连接失败 | 连接数耗尽、数据库服务宕机、网络问题 | 连接数统计、数据库状态、网络连通性 |
| Redis 命中率低 | 缓存策略问题、数据过期时间太短、Redis 内存不足 | 命中率监控、配置检查、内存使用率 |
| AI 响应失败 | AI 模型服务异常、知识库服务异常、API 限流 | 服务状态检查、错误日志分析、限流配置 |

3. **二分法排查**

如果不确定问题范围，使用二分法逐步缩小范围：

```
全部用户 → 部分用户 → 特定用户 → 特定操作 → 特定代码
```

---

##### 步骤 3: 根因分析 (15-60 分钟)

**5 Whys 方法:**

通过连续问"为什么"来找到根本原因。

**示例:**

```
问题: AI 对话响应失败率突然升高

为什么 1: AI 模型服务返回大量 500 错误
为什么 2: AI 模型服务负载过高
为什么 3: 请求量突然增加 5 倍
为什么 4: 新功能的 AI 调用逻辑有问题
为什么 5: 代码上线前没有进行负载测试

根因: 新功能上线前未进行充分的负载测试，导致 AI 模型服务过载
```

**鱼骨图 (因果图):**

从人、机、料、法、环、测六个维度分析：

- **人**: 操作失误、培训不足
- **机**: 服务器故障、网络问题
- **料**: 数据异常、第三方服务异常
- **法**: 流程缺陷、设计问题
- **环**: 环境差异、外部因素
- **测**: 测试覆盖不足、监控缺失

---

##### 步骤 4: 制定修复方案 (5-15 分钟)

**修复方案优先级:**

| 优先级 | 方案类型 | 说明 | 示例 |
|--------|---------|------|------|
| P0 | 立即止损 | 快速恢复服务的临时措施 | 回滚版本、扩容服务器、重启服务 |
| P1 | 修复问题 | 解决根本问题的措施 | 修复代码bug、优化慢查询 |
| P2 | 预防措施 | 防止问题再次发生的措施 | 添加监控、改进测试、优化流程 |

**方案评估维度:**

1. **时效性**: 需要多长时间实施？
2. **风险性**: 实施过程中可能产生什么副作用？
3. **有效性**: 能否彻底解决问题？
4. **资源需求**: 需要哪些资源支持？

**决策流程:**

```
提出方案 → 风险评估 → 资源评估 → IC 决策 → 开始实施
```

---

#### 2.3.2 修复实施

**实施原则:**

1. **快速恢复优先**: 先实施 P0 方案恢复服务
2. **最小化影响**: 选择影响最小的修复方式
3. **可回滚**: 所有修复方案都应可回滚
4. **分阶段实施**: 复杂修复分阶段进行，每个阶段验证后再继续

**修复清单:**

```
□ 备份当前状态（代码、配置、数据）
□ 在测试环境验证修复方案
□ 制定回滚计划
□ 通知相关方维护窗口
□ 开始实施修复
□ 验证修复效果
□ 监控异常指标
□ 更新事故状态
□ 通报修复进展
```

---

### 2.4 事故恢复

#### 2.4.1 验证恢复

**验证步骤:**

1. **功能验证**
   - 受影响的功能是否正常
   - 业务流程是否完整
   - 边界情况是否处理

2. **数据验证**
   - 数据是否完整
   - 数据是否一致
   - 数据丢失是否恢复

3. **性能验证**
   - 响应时间是否恢复正常
   - 系统负载是否正常
   - 资源使用是否正常

4. **监控验证**
   - 异常指标是否消除
   - 告警是否停止
   - 日志是否正常

**验证工具:**

- 自动化测试套件
- 监控看板
- 手工测试清单

---

#### 2.4.2 恢复后监控

**监控时长:**
- P0 事故: 监控 4-8 小时
- P1 事故: 监控 2-4 小时
- P2 事故: 监控 1-2 小时
- P3 事故: 监控 30 分钟-1 小时

**监控指标:**

1. **业务指标**
   - 错误率
   - 响应时间
   - 成功率

2. **技术指标**
   - CPU/内存使用率
   - 数据库连接数
   - Redis 命中率

3. **用户体验指标**
   - 用户投诉数量
   - 客服工单数量
   - 用户满意度评分

---

### 2.5 事故复盘

#### 2.5.1 复盘会议

**时间要求:**

| 事故级别 | 复盘会议时间 |
|---------|-------------|
| P0 | 事故解决后 24 小时内 |
| P1 | 事故解决后 48 小时内 |
| P2 | 事故解决后 1 周内 |
| P3 | 事故解决后 2 周内 |

**参会人员:**

- 事故指挥官 (IC)
- 技术负责人
- 相关工程师
- 产品经理（可选）
- 运营/客服代表（可选）

---

#### 2.5.2 复盘议程

| 时间 | 议题 | 负责人 |
|------|------|-------|
| 5 分钟 | 会议介绍和目标 | IC |
| 10 分钟 | 事故时间线回顾 | IC |
| 15 分钟 | 问题诊断和修复过程 | 技术负责人 |
| 10 分钟 | 影响评估 | 产品经理 |
| 20 分钟 | 根因分析 | 全体 |
| 20 分钟 | 改进措施讨论 | 全体 |
| 10 分钟 | 行动计划确认 | IC |
| 5 分钟 | 总结 | IC |

**会议时长:** 约 1.5 小时

---

#### 2.5.3 复盘报告模板

```markdown
# 事故复盘报告

## 基本信息

| 项目 | 内容 |
|------|------|
| 事故 ID | INC-20260214-001 |
| 事故级别 | P0/P1/P2/P3 |
| 事故时间 | {开始时间} - {结束时间} |
| 持续时长 | {时长} |
| 事故指挥官 (IC) | {姓名} |
| 影响范围 | {受影响的功能/用户} |
| 用户影响 | {具体影响} |

## 事故时间线

| 时间 | 事件 | 负责人 |
|------|------|-------|
| 10:00 | 事故发现 | {姓名} |
| 10:05 | 确认事故级别，组建响应团队 | IC |
| 10:10 | 完成初步影响评估 | IC |
| ... | ... | ... |

## 根因分析

### 直接原因
{直接导致事故的原因}

### 根本原因
{5 Whys 分析结果}

### 关联因素
{其他 contributing factors}

## 影响评估

### 业务影响
- 受影响用户数: {数量}
- 订单损失: {金额}
- 客户投诉: {数量}
- ...

### 技术影响
- 受影响服务: {服务列表}
- 数据影响: {数据丢失/损坏情况}
- ...

### 品牌影响
- 社交媒体负面评价: {数量}
- 客户流失风险: {评估}

## 处理过程

### 采取的措施
1. {措施 1}
2. {措施 2}
3. ...

### 修复方案
{修复方案描述}

### 验证结果
{验证结果描述}

## 经验教训

### 做得好的地方
1. ...
2. ...
3. ...

### 做得不好的地方
1. ...
2. ...
3. ...

## 改进措施

### 立即行动项

| ID | 描述 | 负责人 | 截止日期 | 状态 |
|----|------|-------|---------|------|
| AI-001 | {行动项描述} | {姓名} | {日期} | 进行中 |
| AI-002 | {行动项描述} | {姓名} | {日期} | 待开始 |

### 长期改进项

| ID | 描述 | 负责人 | 截止日期 | 状态 |
|----|------|-------|---------|------|
| LI-001 | {改进项描述} | {姓名} | {日期} | 待开始 |
| LI-002 | {改进项描述} | {姓名} | {日期} | 待开始 |

## 行动计划

### 技术改进
- {改进 1}
- {改进 2}

### 流程改进
- {改进 1}
- {改进 2}

### 工具改进
- {改进 1}
- {改进 2}

### 培训改进
- {改进 1}
- {改进 2}

## 附录

### 相关日志
- {日志链接}

### 相关文档
- {文档链接}

### 相关告警
- {告警链接}

---

报告人: {姓名}
日期: {日期}
```

---

#### 2.5.4 行动项跟踪

**跟踪工具:**

- Jira / GitHub Issues
- 内部任务管理系统
- 复盘报告文档

**跟踪流程:**

1. 创建行动项
2. 分配负责人
3. 设定截止日期
4. 定期跟进
5. 完成后关闭
6. 下次复盘回顾完成情况

---

## 3. 常见问题诊断指南

### 3.1 系统不可用

**症状:** 所有用户无法访问系统

**排查步骤:**

1. **检查基础设施**
   ```bash
   # 检查服务器状态
   ping api.claw.ai

   # 检查服务进程
   ps aux | grep claw-ai-backend

   # 检查端口监听
   netstat -tlnp | grep 8080
   ```

2. **检查负载均衡器**
   - 检查 LB 配置是否正确
   - 检查后端服务健康状态
   - 检查 LB 是否过载

3. **检查 DNS**
   ```bash
   # DNS 查询
   nslookup api.claw.ai
   dig api.claw.ai
   ```

4. **检查网络**
   - 检查防火墙规则
   - 检查安全组配置
   - 检查 CDN 配置

---

### 3.2 API 响应慢

**症状:** API 请求响应时间过长

**排查步骤:**

1. **分析慢接口**
   ```sql
   -- 查询慢接口统计
   SELECT
     endpoint,
     AVG(duration) AS avg_duration,
     PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration) AS p95_duration,
     COUNT(*) AS request_count
   FROM api_metrics
   WHERE timestamp >= NOW() - INTERVAL '1 hour'
   GROUP BY endpoint
   ORDER BY p95_duration DESC
   LIMIT 10;
   ```

2. **检查数据库慢查询**
   ```sql
   -- 查询慢查询日志
   SELECT
     query,
     duration,
     timestamp
   FROM slow_query_log
   WHERE timestamp >= NOW() - INTERVAL '1 hour'
   ORDER BY duration DESC
   LIMIT 10;
   ```

3. **检查外部依赖**
   - 检查第三方 API 响应时间
   - 检查网络延迟
   - 检查依赖服务状态

4. **检查缓存命中率**
   ```bash
   # Redis 命中率
   redis-cli INFO stats | grep keyspace_hits
   redis-cli INFO stats | grep keyspace_misses
   ```

---

### 3.3 数据库连接失败

**症状:** 无法连接数据库或连接数耗尽

**排查步骤:**

1. **检查数据库服务状态**
   ```bash
   # 检查数据库进程
   ps aux | grep postgres

   # 检查数据库连接
   psql -h localhost -U postgres -c "SELECT version();"
   ```

2. **检查连接数**
   ```sql
   -- 查询当前连接数
   SELECT count(*) FROM pg_stat_activity;

   -- 查询连接状态分布
   SELECT state, count(*)
   FROM pg_stat_activity
   GROUP BY state;
   ```

3. **检查长连接**
   ```sql
   -- 查询长时间运行的查询
   SELECT
     pid,
     now() - pg_stat_activity.query_start AS duration,
     query,
     state
   FROM pg_stat_activity
   WHERE (now() - pg_stat_activity.query_start) > interval '5 minutes'
   ORDER BY duration DESC;
   ```

4. **检查锁等待**
   ```sql
   -- 查询锁等待
   SELECT
     blocked_locks.pid AS blocked_pid,
     blocked_activity.usename AS blocked_user,
     blocking_locks.pid AS blocking_pid,
     blocking_activity.usename AS blocking_user,
     blocked_activity.query AS blocked_statement,
     blocking_activity.query AS current_statement_in_blocking_process
   FROM pg_catalog.pg_locks blocked_locks
   JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
   JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
   JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
   WHERE NOT blocked_locks.GRANTED;
   ```

---

### 3.4 AI 响应失败

**症状:** AI 对话返回错误或超时

**排查步骤:**

1. **检查 AI 模型服务状态**
   ```bash
   # 检查服务健康状态
   curl http://ai-model-service:8000/health

   # 检查服务日志
   kubectl logs -f deployment/ai-model-service
   ```

2. **分析失败原因**
   ```sql
   -- 查询失败原因统计
   SELECT
     failure_reason,
     COUNT(*) AS count,
     COUNT(*) * 100.0 / SUM(COUNT(*)) OVER() AS percentage
   FROM ai_dialog_metrics
   WHERE status = 'failed'
     AND timestamp >= NOW() - INTERVAL '1 hour'
   GROUP BY failure_reason
   ORDER BY count DESC;
   ```

3. **检查知识库服务**
   ```bash
   # 检查知识库服务
   curl http://knowledge-base-service:8001/health

   # 检查知识库查询性能
   curl -X POST http://knowledge-base-service:8001/search \
     -H "Content-Type: application/json" \
     -d '{"query": "测试查询"}'
   ```

4. **检查 API 限流**
   - 检查限流配置
   - 检查当前请求速率
   - 检查是否触发限流

---

### 3.5 Redis 命中率低

**症状:** Redis 缓存命中率低，影响性能

**排查步骤:**

1. **检查命中率**
   ```bash
   # 查看 Redis 信息
   redis-cli INFO stats | grep keyspace

   # 计算命中率
   # 命中率 = keyspace_hits / (keyspace_hits + keyspace_misses)
   ```

2. **检查内存使用**
   ```bash
   # 查看内存使用情况
   redis-cli INFO memory

   # 查看过期键数量
   redis-cli INFO stats | grep expired
   ```

3. **检查缓存策略**
   - 检查缓存过期时间设置
   - 检查缓存更新策略
   - 检查缓存预热机制

4. **分析缓存未命中原因**
   - 查看应用日志
   - 分析未命中的 key 模式
   - 检查是否有缓存穿透

---

## 4. 工具和资源

### 4.1 监控工具

| 工具 | 用途 | 文档链接 |
|------|------|---------|
| Grafana | 数据可视化 | https://grafana.com/docs/ |
| Prometheus | 指标采集和存储 | https://prometheus.io/docs/ |
| Kibana | 日志分析 | https://www.elastic.co/guide/en/kibana/ |
| AlertManager | 告警管理 | https://prometheus.io/docs/alerting/latest/alertmanager/ |

### 4.2 诊断工具

| 工具 | 用途 | 文档链接 |
|------|------|---------|
| Postman | API 测试 | https://learning.postman.com/ |
| tcpdump | 网络抓包 | https://www.tcpdump.org/ |
| strace | 系统调用跟踪 | https://strace.io/ |
| perf | 性能分析 | https://perf.wiki.kernel.org/ |

### 4.3 事故管理工具

| 工具 | 用途 | 文档链接 |
|------|------|---------|
| PagerDuty | 值班管理 | https://www.pagerduty.com/docs/ |
| OpsGenie | 告警管理 | https://www.atlassian.com/software/opsgenie |
| Jira | 问题跟踪 | https://www.atlassian.com/software/jira |
| Confluence | 文档管理 | https://www.atlassian.com/software/confluence |

---

## 5. 培训和演练

### 5.1 培训计划

| 培训内容 | 目标人群 | 频率 | 时长 |
|---------|---------|------|------|
| 事故响应流程 | 全体技术团队 | 入职培训 + 每年复训 | 2 小时 |
| 监控工具使用 | 运维团队 | 每季度 | 1 小时 |
| 问题诊断技巧 | 工程师 | 每半年 | 2 小时 |
| 复盘方法 | 技术负责人 | 每年 | 1 小时 |

### 5.2 演练计划

| 演练类型 | 频率 | 参与者 | 持续时间 |
|---------|------|-------|---------|
| P0 事故演练 | 每季度 | 全体技术团队 | 2 小时 |
| 监控告警测试 | 每月 | 运维团队 | 1 小时 |
| 灾难恢复演练 | 每半年 | 运维 + DBA | 4 小时 |
| 安全事件演练 | 每年 | 全体技术团队 | 3 小时 |

---

## 6. 附录

### 6.1 联系人清单

| 角色 | 姓名 | 飞书 | 手机 | 邮箱 |
|------|------|------|------|------|
| 技术总监 | [待填写] | @xxx | 138xxxx | xxx@claw.ai |
| 后端负责人 | [待填写] | @xxx | 139xxxx | xxx@claw.ai |
| 运维负责人 | [待填写] | @xxx | 135xxxx | xxx@claw.ai |
| DBA | [待填写] | @xxx | 136xxxx | xxx@claw.ai |
| AI 负责人 | [待填写] | @xxx | 137xxxx | xxx@claw.ai |

### 6.2 应急联系方式

- **技术应急群**: 飞书群（所有技术团队）
- **管理层应急群**: 飞书群（技术 + 产品 + 管理层）
- **24 小时值班电话**: 400-xxx-xxxx

### 6.3 相关文档

- [产品监控体系](/home/wuying/clawd/claw-intelligence/reports/product-monitoring-strategy-2026-02-14.md)
- [告警规则文档](/home/wuying/clawd/claw-ai-backend/docs/ALERTING_RULES.md)
- [告警通知配置](/home/wuying/clawd/claw-ai-backend/config/alerting.yaml)

---

**文档结束**
